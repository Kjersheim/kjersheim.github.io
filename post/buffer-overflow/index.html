<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://kjersheim.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://kjersheim.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://kjersheim.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://kjersheim.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://kjersheim.github.io/css/light.css' />
    <link rel="stylesheet" href='https://kjersheim.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://kjersheim.github.io/css/syntax.css' />
    <title>Buffer overflow analysis: stack_1 - Kjersheim - Projects &amp; Docs</title>
    
    <link rel="icon" type="image/x-icon" href='https://kjersheim.github.io/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    

    
    <meta name="description"
  content="Exploring an executable through linux and windows, using IDA community edition" />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://kjersheim.github.io/post/buffer-overflow/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Buffer overflow analysis: stack_1 - Kjersheim - Projects &amp; Docs" />
<meta name="twitter:description"
  content="Exploring an executable through linux and windows, using IDA community edition" />
<meta name="twitter:site" content="https://kjersheim.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://kjersheim.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Buffer overflow analysis: stack_1 - Kjersheim - Projects &amp; Docs">
<meta property="og:description"
  content="Exploring an executable through linux and windows, using IDA community edition" />
<meta property="og:url" content="https://kjersheim.github.io/post/buffer-overflow/" />
<meta property="og:site_name" content="Buffer overflow analysis: stack_1" />
<meta property="og:image"
  content="https://kjersheim.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2024-10-25 00:00:00 &#43;0000 UTC" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://kjersheim.github.io/">
        <img class="octicon" height="32" width="32" src="/images/avatar.svg">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://kjersheim.github.io/">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://kjersheim.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/avatar.svg">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://kjersheim.github.io/">
                  <img class=" avatar-user"
                    src="/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://kjersheim.github.io/">Andreas</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://kjersheim.github.io/post/buffer-overflow/">Buffer overflow analysis: stack_1</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Fri, 25 Oct 2024 00:00:00 &#43;0000"
                    class="no-wrap">
                    Fri, 25 Oct 2024 00:00:00 &#43;0000</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      1471 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h1 id="buffer-overflow-analysis-stack_1">Buffer overflow analysis: stack_1</h1>
<h2 id="initial-analysis">Initial analysis</h2>
<p>The readelf command is often the first step in analyzing an executable file, providing an overview of its sections, symbols, and structure. Running readelf on stack_1 hinted at the presence of several hidden flags within the binary, specifically suggesting that at least five flags could be found. Commands such as -S (section headers) and -h (file headers) were also tested, but these did not yield additional noteworthy insights.</p>
<p><img src="/images/buffer-overflow-stack1/1.jpg" alt="Checking the file stack_1 using readelf command"></p>
<p>Utilizing the strings command allowed for the extraction of readable ASCII strings from the binary. This revealed explicit references to flags labeled from 1 to 5, clearly indicating multiple levels or checks within the application. Additionally, a username &ldquo;Shirley&rdquo; was discovered, prompting further investigation into her potential role or significance in the execution flow.</p>
<p><img src="/images/buffer-overflow-stack1/2.jpg" alt="Strings command"></p>
<p>The objdump tool offered a detailed view of the binary’s assembly-level code, identifying specific memory addresses and code sections that warranted closer inspection. These addresses were noted for future reference, as they might relate to conditions checked for each flag.</p>
<p><img src="/images/buffer-overflow-stack1/3.jpg" alt="Objdump command"></p>
<h2 id="analysis-with-ida-community-edition">Analysis with IDA community edition</h2>
<p>At this point I had opened a copy of stack_1 in IDA, which showed different chains of locations. Some information could be seen there too, like Shirley. Another interesting thing was that on the same part that replied regarding Shirley, another option would be to test to compare a value and if not zero – it would jump to a new chain later promting good work flag 1 completed.</p>
<p>The program prompts for a username, and then uses _strtok and _strcmp to process it. If it checks Shirley, it prints “ok Shirley, try to get the flags next”. If not, it prints “who is <em>whatever we inserted</em>”.</p>
<p>If Shirley is entered as a input, then a series of checks are performed, where it evaluates the “flag” variable and other things.
We do see multiple flags, flag_1 done, flag_2 done etc up until flag 5.</p>
<p>Each flag seems to be checked by comparing a specific value or strings in memory.</p>
<h3 id="flag-1">Flag 1</h3>
<p>If the flag variable is zero, then it writes the Shirley message. If it is not zero, then it writes the flag_1 line.</p>
<p><img src="/images/buffer-overflow-stack1/4.jpg" alt="Shirley check vs flag 1, IDA"></p>
<p>From the local variables in the main function, we see what should be the location for the flag variable: 0x18.</p>
<p><img src="/images/buffer-overflow-stack1/9.jpg" alt="variable location flag 1, IDA"></p>
<p>Opening stack_1 with GDB, setting a breakpoint at the location for the flag conditional check, and at that point we can inspect the variable as well as change it to 1 which we want to test to pass the check.</p>
<p><img src="/images/buffer-overflow-stack1/10.jpg" alt="Changing variable to pass conditional check, IDA"></p>
<h3 id="flag-2">Flag 2</h3>
<p>After the flag_1 check, the program checks for a specific value in the flag variable, 0xDEADC0DE</p>
<p><img src="/images/buffer-overflow-stack1/5.jpg" alt="Flag2, IDA"></p>
<p>Since we derived from looking at the disassembly earlier, the flag variable is also the one checked to find the flag_2 – using the deadcode hex instead of the 0 or 1. Testing by running the program again, on the same breakpoint. At that stop, I similarly as in flag_1 change to 0xDEADC0DE instead of 0. Continuing the program after that, reveals the flag_2 done string.</p>
<p><img src="/images/buffer-overflow-stack1/11.jpg" alt="Flag2, GDB"></p>
<p>As the green arrow indicates, also the third flag message is revealed at this point.</p>
<h3 id="flag-3">Flag 3</h3>
<p>Seems to involve canary values, security measure against buffer overflow attacks. The value seems to be set to an ascii string “notabird”.
The program checks if the canary is unchanged, and if it is intact flag_3 message is printed.</p>
<p><img src="/images/buffer-overflow-stack1/6.jpg" alt="Flag3, IDA"></p>
<p>As the requirement for the flag_3 was that the canary value should be unchanged, and the methods used so far does not overwrite it, I run it again to inspect the local variable for canary which is stored in ebp-0x12. As it shows in the figure below, its still “notabird.” and presumably that’s it, at this part, we might need to overwrite it later – should be enough for the third flag.</p>
<p><img src="/images/buffer-overflow-stack1/12.jpg" alt="Flag3 canary location and value, GDB"></p>
<h3 id="flag-4">Flag 4</h3>
<p>In the same section as the canary above, there is a value 0xCAFECAFE that should refer to flag_4. After the canary passes, it checks a memory location ebp+4 to see if it holds the mentioned value.</p>
<p><img src="/images/buffer-overflow-stack1/7.jpg" alt="Flag4, IDA"></p>
<p>For the fourth flag, as discussed above it compares a value at ebp+4 for CAFECAFE.</p>
<p><img src="/images/buffer-overflow-stack1/13.jpg" alt="Flag4, GDB"></p>
<p>Testing to change the ebp+4 value, but quickly notice that the previous flags need to be changed as well due to it all running in a chain.</p>
<p><img src="/images/buffer-overflow-stack1/14.jpg" alt="Flag4, GDB"></p>
<p>Trying again with all flags set – and then it prompts the flag_4 message successfully:</p>
<p><img src="/images/buffer-overflow-stack1/15.jpg" alt="Flag1-4, GDB"></p>
<h3 id="flag-5">Flag 5</h3>
<p>The last one (from what we see so far) has its own subroutine and seems to be a bit different than the others. The other flags are chained if we inspect the graph view of IDA, so it seems maybe it needs to have the previous flags correct and then some other values must be maybe overflowed.</p>
<p><img src="/images/buffer-overflow-stack1/8.jpg" alt="Flag4, IDA"></p>
<p>The last flag seems more intricate than the previous ones. If I understand it correctly we would need to somehow overflow more, and then I am also guessing we are overflowing the canary which breaks the chain. If we can create an input that contains the canary at the right location that could be something we could try. From what I have read so far in the course, canaries should be created as random on each instance the program is run – so it is not predictable. However, this does not seem to be the case here? Running everything we have done so far again, and inspecting the canary, both as string and bytes:</p>
<p><img src="/images/buffer-overflow-stack1/16.jpg" alt="Flag5 testing, GDB"></p>
<p>Additionally, I cant see a way it jumps to the flag_5 area, so it might be that we need to set the address that it should jump to manually. However, as seen in the image below while finding flag_5 I am overwriting flag_4:</p>
<p><img src="/images/buffer-overflow-stack1/17.jpg" alt="Flag5 found, GDB"></p>
<h3 id="gdb-scripts-briefly">GDB scripts, briefly</h3>
<p>Setting up .gdb scripts can make life a bit easier in these processes, where steps are repeated over and over again. In this test, I createed a .gdb file that I can pre-fill with the commands I want entered upon launch, as seen below in the flag1to4.gdb</p>
<p><img src="/images/buffer-overflow-stack1/18.jpg" alt=".gdb script"></p>
<p>Then when running gdb with the -x option and naming the file, it loads everything ready up until the green line below.</p>
<p><img src="/images/buffer-overflow-stack1/19.jpg" alt=".gdb script in use"></p>
<h2 id="creating-a-python-exploit-script">Creating a python exploit script</h2>
<p>Analyzing the code first, as I did not initially realize I had this and instead added letters one by one to the script till I got the segmentation fault error.</p>
<p><img src="/images/buffer-overflow-stack1/20.jpg" alt="Analyzing the stack"></p>
<pre><code>Possible stack:
Buffer for username 20 bytes
Canary 10 bytes
Volatile (not to optimize/change) int paddy 4 bytes
Flag variable (volatile) 4 bytes
Base pointer 4 bytes
Return address 4 bytes
(higher addresses)
</code></pre>
<p>Total 46 (48 from testing with GDB)  bytes used above here, fgets reads 128, so we can recreate the required info within the input.</p>
<p>According to the variable sizes I found in the code, and similar to previously analyzed in IDA and GDB, the fgets function reads 128 bytes from user input in the username buffer – which is only 20 bytes long. This seems like the buffer overflow exploit possibility.</p>
<p>The canary is not random but “notabird.” And initialized and set when the program is run from the #define CANARY. We can calculate the location of this, at least from the start of the input.</p>
<pre><code>Username Shirley
Flag 1 if the flag var is set to a non-zero value
Flag 2 if the flag var is set to 0xdeadc0de
Flag 3 canary check, if it still matches “notabird.”
Flag 4 if the return address of main equals 0xcafecafe
</code></pre>
<p>Using msf-pattern_create, I created a pattern to test, so I can find more information about the buffer</p>
<p><img src="/images/buffer-overflow-stack1/21.jpg" alt="Pattern test"></p>
<p>The program crashes at 0x41366241 location. Which we see the instruction pointer EIP is pointing at. If we focus on the instruction pointer, as we want to overwrite this with a return address of our chosing.</p>
<p>(gdb) run &lt; &lt;(python3 -c &ldquo;print(&lsquo;A&rsquo; * 45 + &lsquo;BBBB&rsquo;)&rdquo;) EIP: 0xf7000042 0xf7000042 B</p>
<p>(gdb) run &lt; &lt;(python3 -c &ldquo;print(&lsquo;A&rsquo; * 47 + &lsquo;BBBB&rsquo;)&rdquo;) EIP: 0x424242 0x424242 BBB</p>
<p>49 gives EIP 0x42424241 0x42424241 BBBA</p>
<p>48 seems to be fully overwriting EIP eip 0x42424242 0x42424242 BBBB</p>
<p><img src="/images/buffer-overflow-stack1/22.jpg" alt="Pattern test 2"></p>
<p>So, 20(username)10(canary)4(paddy-padding)4(flag)4(basepointer)4(returnaddress). This only account for 46, maybe some kind of extra padding somewhere added by the compiler to make it align to 4 or 8 byte sections. First attempt fails due to Shirley-compare check gets incorrect due to I initially just padded the username with As:</p>
<p><img src="/images/buffer-overflow-stack1/23.jpg" alt="First exploit test"></p>
<p>Instead, I added a null terminator between the username and the padding with A’s,  which successfully shows flag 1:</p>
<p><img src="/images/buffer-overflow-stack1/24.jpg" alt="Second exploit test"></p>
<p>Played around with the ordering and if we check the code it suggests the order of information-pieces we need to insert into our buffer should be:
Username – padding to fill username – flag value (non zero (and deadc0de) – canary – paddy padding, padding for argc, padding for argv - return address</p>
<p><img src="/images/buffer-overflow-stack1/25.jpg" alt="Third exploit test"></p>
<p>For the final 5th flag, simply switching out the return address for flag 4 to the flag 5 location, which we saw earlier using IDA.</p>
<p><img src="/images/buffer-overflow-stack1/27.jpg" alt="IDA flag 5 return address, IDA"></p>
<p><img src="/images/buffer-overflow-stack1/26.jpg" alt="Fourth exploit test"></p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://kjersheim.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://kjersheim.github.io/css/toc.css' />

  
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://kjersheim.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="https://kjersheim.github.io/js/github-style.js"></script>







</html>